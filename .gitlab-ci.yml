image: quay.io/tike/alpine-oc-node

stages:
    - setup
    - test
    - build
    - sonarqube-check

variables:
    PROJECT_NAME: "imitaatiopeli-frontend"
    PROJECT_VERSION: "1.0.0"
    npm_config_cache: '$CI_PROJECT_DIR/.npm'


.dependencies_cache:
    cache:
        key:
            files:
                - package-lock.json
        paths:
            - .npm
        policy: pull

setup:
    stage: setup
    tags:
        - ohtu-build-3
    script:
        - npm ci
    extends: .dependencies_cache
    cache:
        policy: pull-push
    artifacts:
        expire_in: 1h
        paths:
            - node_modules

test:
    stage: test
    image: node:22-alpine
    tags:
        - ohtu-build-3
    script:
        - npm run test:coverage
    extends: .dependencies_cache
    artifacts:
        name: coverage-test
        paths:
            - coverage/

build_stage_dev:
    stage: build
    image: node:22-alpine
    only:
        - main
    tags:
        - ohtu-build-3
    extends: .dependencies_cache
    script:
        - npm run build -- --mode development
        - CI=false NODE_ENV=production npm run build
    artifacts:
        name: imitaatiopeli-build
        paths:
            - dist
        expire_in: 1 hour

build_stage_test:
    stage: build
    image: node:22-alpine
    only:
        - test
    tags:
        - ohtu-build-3
    script:
        - npm ci --omit=dev
        - npm run build -- --mode test
        - CI=false NODE_ENV=production npm run build
    artifacts:
        name: imitaatiopeli-build
        paths:
            - build
        expire_in: 1 hour

build_stage-prod:
    stage: build
    image: node:22-alpine
    only:
        - prod
    tags:
        - ohtu-build-3
    script:
        - npm ci --omit=dev
        - npm run build -- --mode production
        - CI=false NODE_ENV=production npm run build
    artifacts:
        name: imitaatiopeli-build
        paths:
            - build
        expire_in: 1 hour


sonarqube-check:
    stage: sonarqube-check
    tags:
        - ohtu-build-3
    image:
        name: sonarsource/sonar-scanner-cli:latest
        entrypoint: [ "" ]
    variables:
        SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
        GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
    cache:
        key: "${CI_JOB_NAME}"
        paths:
            - .sonar/cache
    script:
        - sonar-scanner
    allow_failure: true
    only:
        - main
